<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirmaDocs - Portal Dokumentów</title>
    <link rel="stylesheet" href="style.css">
    <!-- Krok 1: Ładujemy bibliotekę Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div id="app-container">
        <!-- === EKRAN LOGOWANIA I REJESTRACJI === -->
        <div id="auth-view">
            <div id="login-form-container">
                <h2>Logowanie</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Hasło" required>
                    <button type="submit">Zaloguj</button>
                </form>
                <p>Nie masz konta? <a href="#" id="show-register-link">Zarejestruj się</a></p>
            </div>
            <div id="register-form-container" class="hidden">
                <h2>Rejestracja</h2>
                <form id="register-form">
                    <input type="text" id="register-fullname" placeholder="Imię i Nazwisko" required>
                    <input type="email" id="register-email" placeholder="Email" required>
                    <input type="password" id="register-password" placeholder="Hasło (min. 6 znaków)" required>
                    <input type="text" id="register-nip" placeholder="NIP firmy" required>
                    <input type="text" id="register-prefix" placeholder="4-cyfrowy kod-prefix" required pattern="\d{4}">
                    <button type="submit">Zarejestruj</button>
                </form>
                <p>Masz już konto? <a href="#" id="show-login-link">Zaloguj się</a></p>
            </div>
            <div id="message-area"></div>
        </div>

        <!-- === GŁÓWNA APLIKACJA (PO ZALOGOWANIU) === -->
        <div id="main-view" class="hidden">
            <header>
                <h1 id="welcome-message">Witaj,</h1>
                <button id="logout-button">Wyloguj</button>
            </header>
            
            <div id="client-dashboard" class="hidden">
                <h2>Twoje Dokumenty</h2>
                <ul id="file-list"></ul>
            </div>

            <div id="admin-dashboard" class="hidden">
                <h2>Panel Administratora</h2>
                <div class="admin-section">
                    <h3>Klienci</h3>
                    <form id="add-client-form">
                        <input type="text" id="client-name" placeholder="Nazwa firmy" required>
                        <input type="text" id="client-nip" placeholder="NIP firmy" required>
                        <button type="submit">Dodaj Klienta</button>
                    </form>
                    <ul id="clients-list"></ul>
                </div>
                <div id="client-details-section" class="admin-section hidden"></div>
            </div>
        </div>
    </div>
    
    <!-- Krok 2: Uruchamiamy CAŁY nasz kod JavaScript TUTAJ -->
    <script>
        // =============================================================
        //  GŁÓWNY KOD APLIKACJI "FIRMADOCS"
        // =============================================================

        // Konfiguracja Połączenia z Supabase
        const SUPABASE_URL = 'https://ytbycwoxkqzerxyzfeku.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0Ynljd294a3F6ZXJ4eXpmZWt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODQzMzIsImV4cCI6MjA3MjU2MDMzMn0.CvFrr2HyZJWQyf0c6S-84SkhGY5voTrn0IaLWQwx6Dc';


        if (!SUPABASE_URL || !SUPABASE_KEY || SUPABASE_URL.includes('TWOJ')) {
            alert("BŁĄD KRYTYCZNY: Proszę wstawić prawidłowy URL i Klucz Supabase w pliku index.html!");
            throw new Error("Supabase URL and Key are required.");
        }
        
        // OSTATECZNA, POPRAWNA INICJALIZACJA:
        // Używamy globalnego obiektu `supabase` z biblioteki załadowanej powyżej.
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // === GŁÓWNA LOGIKA APLIKACJI ===
        // Czekamy, aż cały dokument HTML będzie gotowy
        document.addEventListener('DOMContentLoaded', () => {
            const authView = document.getElementById('auth-view');
            const mainView = document.getElementById('main-view');
            const showLoginLink = document.getElementById('show-login-link');
            const showRegisterLink = document.getElementById('show-register-link');

            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(true); });
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms(false); });

            function toggleAuthForms(showLogin) {
                document.getElementById('login-form-container').classList.toggle('hidden', !showLogin);
                document.getElementById('register-form-container').classList.toggle('hidden', showLogin);
            }

            async function checkUserStatus() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    authView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    initializeApp(session.user);
                } else {
                    authView.classList.remove('hidden');
                    mainView.classList.add('hidden');
                }
            }

            async function initializeApp(user) {
                const { data: profile } = await supabaseClient.from('profiles').select('*, clients(*)').eq('id', user.id).single();
                if (!profile) {
                    alert('Nie udało się załadować profilu użytkownika. Spróbuj ponownie.'); return;
                }
                document.getElementById('welcome-message').textContent = `Witaj, ${profile.full_name || user.email}`;
                if (profile.role === 'admin') {
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    loadAdminDashboard();
                } else {
                    if (profile.clients) {
                        document.getElementById('client-dashboard').classList.remove('hidden');
                        loadClientDashboard(profile.clients.storage_folder_path);
                    } else {
                        const clientDashboard = document.getElementById('client-dashboard');
                        clientDashboard.innerHTML = '<p>Twoje konto nie jest jeszcze przypisane do żadnego klienta. Skontaktuj się z administratorem.</p>';
                        clientDashboard.classList.remove('hidden');
                    }
                }
            }

            async function loadClientDashboard(folderPath) {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '<li>Ładowanie plików...</li>';
                const { data, error } = await supabaseClient.storage.from('client-documents').list(folderPath);
                if (error || !data || data.length === 0) {
                    fileList.innerHTML = '<li>Brak plików do wyświetlenia.</li>'; return;
                }
                fileList.innerHTML = '';
                for (const file of data) {
                    const { data: { publicUrl } } = supabaseClient.storage.from('client-documents').getPublicUrl(`${folderPath}/${file.name}`);
                    fileList.innerHTML += `<li><span>${file.name}</span> <a href="${publicUrl}" class="file-link" target="_blank" download>Pobierz</a></li>`;
                }
            }

            async function loadAdminDashboard() {
                const clientsList = document.getElementById('clients-list');
                async function fetchAndRenderClients() {
                    const { data: clients } = await supabaseClient.from('clients').select('*').order('company_name');
                    clientsList.innerHTML = '';
                    clients.forEach(client => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${client.company_name} (NIP: ${client.nip})</span><button class="action-button delete-btn delete-client-btn" data-client-id="${client.id}">Usuń</button>`;
                        li.dataset.clientId = client.id;
                        li.style.cursor = 'pointer';
                        clientsList.appendChild(li);
                    });
                }
                document.getElementById('add-client-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('client-name').value;
                    const nip = document.getElementById('client-nip').value;
                    await supabaseClient.from('clients').insert({ company_name: name, nip });
                    e.target.reset();
                    await fetchAndRenderClients();
                });
                clientsList.addEventListener('click', (e) => {
                    if (e.target.matches('.delete-client-btn')) {
                        e.stopPropagation();
                        if(confirm('Czy na pewno usunąć tego klienta i wszystkie jego dane?')) {
                            supabaseClient.from('clients').delete().eq('id', e.target.dataset.clientId).then(fetchAndRenderClients);
                        }
                    } else if (e.target.closest('li')) {
                        renderClientDetails(e.target.closest('li').dataset.clientId);
                    }
                });
                await fetchAndRenderClients();
            }

            async function renderClientDetails(clientId) {
                const detailsSection = document.getElementById('client-details-section');
                const { data: client } = await supabaseClient.from('clients').select('*').eq('id', clientId).single();
                const { data: codes } = await supabaseClient.from('registration_codes').select('*').eq('client_id_to_assign', clientId);
                detailsSection.innerHTML = `<h3>Szczegóły: ${client.company_name}</h3><h4>Kody Rejestracyjne</h4><ul id="codes-list">${codes.map(code => `<li><span class="code-prefix">${code.prefix}</span> <span>${code.is_used ? 'Wykorzystany' : 'Aktywny'}</span> <button class="action-button delete-btn delete-code-btn" data-code-id="${code.id}">Usuń</button></li>`).join('') || '<li>Brak kodów.</li>'}</ul><form id="generate-code-form"><button type="submit">Generuj nowy kod 4-cyfrowy</button></form><h4>Zarządzaj Plikami</h4><ul id="admin-file-list">Ładowanie...</ul><form id="admin-upload-form"><input type="file" id="file-upload-input" multiple required><button type="submit">Wgraj wybrane pliki</button></form>`;
                detailsSection.classList.remove('hidden');
                document.getElementById('generate-code-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const newPrefix = Math.floor(1000 + Math.random() * 9000).toString();
                    await supabaseClient.from('registration_codes').insert({ prefix: newPrefix, client_id_to_assign: clientId });
                    renderClientDetails(clientId);
                };
                const adminFileList = document.getElementById('admin-file-list');
                async function fetchAndRenderFiles() {
                    const { data } = await supabaseClient.storage.from('client-documents').list(client.storage_folder_path);
                    adminFileList.innerHTML = data && data.length > 0 ? data.map(file => `<li><span>${file.name}</span><button class="action-button delete-btn delete-file-btn" data-file-path="${client.storage_folder_path}/${file.name}">Usuń</button></li>`).join('') : '<li>Brak plików.</li>';
                }
                document.getElementById('admin-upload-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const files = document.getElementById('file-upload-input').files;
                    for (const file of files) {
                        await supabaseClient.storage.from('client-documents').upload(`${client.storage_folder_path}/${file.name}`, file);
                    }
                    fetchAndRenderFiles();
                };
                detailsSection.onclick = async (e) => {
                    if (e.target.matches('.delete-code-btn')) {
                        await supabaseClient.from('registration_codes').delete().eq('id', e.target.dataset.codeId);
                        renderClientDetails(clientId);
                    }
                    if (e.target.matches('.delete-file-btn')) {
                        await supabaseClient.storage.from('client-documents').remove([e.target.dataset.filePath]);
                        fetchAndRenderFiles();
                    }
                };
                await fetchAndRenderFiles();
            }
            
            function showMessage(text, type) {
                const messageArea = document.getElementById('message-area');
                messageArea.textContent = text;
                messageArea.className = `message-${type}`;
                setTimeout(() => messageArea.textContent = '', 5000);
            }

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) showMessage(error.message, 'error');
                else checkUserStatus();
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { data, error } = await supabaseClient.functions.invoke('register-client', {
                    body: {
                        email: document.getElementById('register-email').value,
                        password: document.getElementById('register-password').value,
                        fullName: document.getElementById('register-fullname').value,
                        nip: document.getElementById('register-nip').value,
                        prefix: document.getElementById('register-prefix').value,
                    }
                });
                if (error || data.error) showMessage(error?.message || data.error, 'error');
                else {
                    showMessage('Rejestracja pomyślna! Sprawdź email, aby potwierdzić konto, a następnie zaloguj się.', 'success');
                    toggleAuthForms(true);
                }
            });

            document.getElementById('logout-button').addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                location.reload();
            });

            checkUserStatus();
        });
    </script>
</body>
</html>
